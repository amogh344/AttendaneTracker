<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Attendance Portal</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .schedule-table th, .schedule-table td {
            vertical-align: middle;
            text-align: center;
            min-height: 80px;
            font-size: 0.9rem;
        }
        .class-cell {
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .class-cell:hover {
            background-color: #e9ecef;
        }
        .swapping {
            cursor: copy;
        }
        .swapping .class-cell:hover {
            outline: 2px dashed #0d6efd;
        }
        .day-header {
            font-weight: 600;
        }
        .btn-day {
            font-size: 0.75rem;
        }
    </style>
</head>
<body>

    <div id="app" class="container my-5">
        <!-- App Header -->
        <header class="mb-5 text-center">
            <h1 class="display-4 fw-bold">Student Attendance Portal</h1>
            <!-- Week Navigation -->
            <div class="mt-4 d-flex align-items-center justify-content-center gap-3">
                <button id="prev-week" class="btn btn-light rounded-pill p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-chevron-left" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/></svg>
                </button>
                <h2 id="week-title" class="h4 fw-semibold m-0" style="width: 280px;"></h2>
                <button id="next-week" class="btn btn-light rounded-pill p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg>
                </button>
            </div>
             <button id="today-btn" class="btn btn-link mt-2">Go to Today</button>
        </header>

        <!-- Loading State -->
        <div id="loading-state" class="text-center py-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Connecting to server...</p>
        </div>

        <div id="app-content" class="d-none">
            <!-- Attendance Summary -->
            <div id="attendance-summary" class="card shadow-sm mb-4">
                <div class="card-body">
                    <h3 class="card-title mb-4">Attendance Summary</h3>
                    <div id="summary-grid" class="row g-3">
                        <!-- Summary cards will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <main id="main-content">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h3 class="card-title mb-4">Weekly Schedule & Attendance</h3>
                        <div id="student-schedule-container" class="table-responsive">
                            <!-- Schedule will be rendered here -->
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Class Action Modal -->
        <div class="modal fade" id="class-action-modal" tabindex="-1" aria-labelledby="modal-title" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header text-center">
                        <h5 class="modal-title w-100 h3" id="modal-title">Class Action</h5>
                    </div>
                    <div class="modal-body">
                        <p class="text-center text-muted" id="modal-subtitle"></p>
                        <div class="d-grid gap-3 mt-4">
                            <button id="mark-present" class="btn btn-success btn-lg">Mark as Present</button>
                            <button id="mark-absent" class="btn btn-danger btn-lg">Mark as Absent</button>
                            <button id="mark-cancelled" class="btn btn-secondary btn-lg">Mark as Cancelled</button>
                            <button id="initiate-swap" class="btn btn-primary btn-lg">Swap Class</button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light w-100" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        // --- API Configuration ---
        const API_URL = 'https://attendance-backend-5lpu.onrender.com/api/data';

        // --- STATE MANAGEMENT ---
        let studentSchedule = {};
        let attendanceRecords = {};
        let swapState = { active: false, source: null };
        let currentDate = new Date();
        let currentWeekId = '';
        let classActionModal; // To hold Bootstrap modal instance

        // --- DATE HELPER FUNCTIONS ---
        function getMonday(d) {
            d = new Date(d);
            const day = d.getDay(),
                diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDate(date) {
            const d = new Date(date),
                year = d.getFullYear(),
                month = '' + (d.getMonth() + 1),
                day = '' + d.getDate();
            return [year, month.padStart(2, '0'), day.padStart(2, '0')].join('-');
        }

        function getWeekDisplayString(date) {
            const monday = getMonday(date);
            const sunday = new Date(monday);
            sunday.setDate(sunday.getDate() + 6);
            const options = { month: 'short', day: 'numeric' };
            return `${monday.toLocaleDateString('en-US', options)} - ${sunday.toLocaleDateString('en-US', { ...options, year: 'numeric' })}`;
        }

        // --- CORE FUNCTIONS ---
        function getStatusColor(status) {
            switch (status) {
                case 'present': return 'table-success';
                case 'absent': return 'table-danger';
                case 'cancelled': return 'text-muted text-decoration-line-through';
                default: return '';
            }
        }

        function renderAttendanceSummary() {
            const container = document.getElementById('summary-grid');
            if (!container || !studentSchedule.rows) return;
            container.innerHTML = '';

            const subjects = [...new Set(studentSchedule.rows.flatMap(row => row.slice(1)).filter(item => item && !['Tea Break', 'Lunch Break'].includes(item)))];
            subjects.forEach(subject => {
                let totalClasses = 0;
                let presentClasses = 0;
                studentSchedule.rows.forEach(row => {
                    const day = row[0];
                    row.slice(1).forEach((item, index) => {
                        if (item === subject) {
                            if (index === 0 || row[index] !== item) {
                                totalClasses++;
                            }
                            const timeSlot = studentSchedule.headers[index + 1];
                            const record = attendanceRecords[day]?.[timeSlot];
                            if (record && record.status === 'present') {
                                if (index === 0 || row[index] !== item) {
                                   presentClasses++;
                                }
                            }
                        }
                    });
                });

                const percentage = totalClasses > 0 ? ((presentClasses / totalClasses) * 100) : 0;
                const summaryCard = document.createElement('div');
                summaryCard.className = 'col-lg-3 col-md-4 col-sm-6';
                const bgColor = percentage >= 75 ? 'bg-success-subtle' : (percentage >= 50 ? 'bg-warning-subtle' : 'bg-danger-subtle');

                summaryCard.innerHTML = `
                    <div class="card h-100 ${bgColor}">
                        <div class="card-body">
                            <h5 class="card-title fw-bold">${subject}</h5>
                            <p class="card-text">${presentClasses} / ${totalClasses} Attended</p>
                            <div class="progress" role="progressbar" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100">
                                <div class="progress-bar" style="width: ${percentage.toFixed(0)}%"></div>
                            </div>
                        </div>
                    </div>`;
                container.appendChild(summaryCard);
            });
            if (subjects.length === 0) container.innerHTML = '<p class="col-12 text-muted">No subjects found in schedule.</p>';
        }
        
        function renderStudentSchedule() {
            if (!studentSchedule.rows) return;
            const container = document.getElementById('student-schedule-container');
            container.innerHTML = '';
            const table = document.createElement('table');
            table.className = 'table table-bordered schedule-table';

            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            studentSchedule.headers.forEach(header => {
                const th = document.createElement('th');
                th.scope = 'col';
                th.textContent = header;
                headerRow.appendChild(th);
            });

            const tbody = table.createTBody();
            studentSchedule.rows.forEach(row => {
                const tr = tbody.insertRow();
                const dayHeaderCell = document.createElement('th');
                dayHeaderCell.scope = 'row';
                dayHeaderCell.className = 'day-header';
                dayHeaderCell.innerHTML = `<span>${row[0]}</span><br><button class="btn btn-primary btn-sm btn-day mt-1">Mark Day</button>`;
                dayHeaderCell.querySelector('button').onclick = (e) => { e.stopPropagation(); markFullDay(row[0]); };
                tr.appendChild(dayHeaderCell);
                
                const classItems = row.slice(1);
                for (let timeIndex = 0; timeIndex < classItems.length; timeIndex++) {
                    const item = classItems[timeIndex];
                    const td = tr.insertCell();
                    if (!item) { tr.appendChild(td); continue; }
                    
                    const day = row[0];
                    const timeSlot = studentSchedule.headers[timeIndex + 1];
                    let colSpan = 1;
                    while (timeIndex + colSpan < classItems.length && classItems[timeIndex + colSpan] === item && !['Tea Break', 'Lunch Break'].includes(item)) {
                        colSpan++;
                    }
                    td.colSpan = colSpan;

                    const attendance = attendanceRecords[day]?.[timeSlot] || {};
                    td.className = getStatusColor(attendance.status);
                    
                    if (item && !['Tea Break', 'Lunch Break'].includes(item)) {
                        td.classList.add('class-cell');
                        td.onclick = () => handleCellClick(item, day, timeSlot, colSpan);
                    } else if (['Tea Break', 'Lunch Break'].includes(item)) {
                         td.classList.add('table-light', 'fw-medium');
                    }
                    td.textContent = item;
                    if (colSpan > 1) timeIndex += colSpan - 1;
                }
            });
            container.appendChild(table);
            renderAttendanceSummary();
        }

        function handleCellClick(subject, day, timeSlot, colSpan = 1) {
            if (swapState.active) {
                if (swapState.source.day === day && swapState.source.timeSlot === timeSlot) {
                    document.body.classList.remove('swapping');
                    swapState = { active: false, source: null };
                    alert('Swap cancelled.');
                } else {
                    completeSwap(day, timeSlot);
                }
            } else {
                openClassActionModal(subject, day, timeSlot, colSpan);
            }
        }
        
        function openClassActionModal(subject, day, timeSlot, colSpan = 1) {
            document.getElementById('modal-title').textContent = subject;
            document.getElementById('modal-subtitle').textContent = `${day} at ${timeSlot}`;
            document.getElementById('mark-present').onclick = () => updateClassStatus(day, timeSlot, 'present', colSpan);
            document.getElementById('mark-absent').onclick = () => updateClassStatus(day, timeSlot, 'absent', colSpan);
            document.getElementById('mark-cancelled').onclick = () => updateClassStatus(day, timeSlot, 'cancelled', colSpan);
            document.getElementById('initiate-swap').onclick = () => initiateSwap(subject, day, timeSlot);
            classActionModal.show();
        }

        function updateClassStatus(day, timeSlot, status, colSpan = 1) {
            if (!attendanceRecords[day]) attendanceRecords[day] = {};
            const startTimeIndex = studentSchedule.headers.indexOf(timeSlot);
            for (let i = 0; i < colSpan; i++) {
                const currentTimeSlot = studentSchedule.headers[startTimeIndex + i];
                if (currentTimeSlot) attendanceRecords[day][currentTimeSlot] = { status };
            }
            closeModal();
            renderStudentSchedule();
            saveData();
        }

        function markFullDay(day) {
            if (!attendanceRecords[day]) attendanceRecords[day] = {};
            const dayRow = studentSchedule.rows.find(r => r[0] === day);
            dayRow.slice(1).forEach((item, index) => {
                if (item && !['Tea Break', 'Lunch Break'].includes(item)) {
                    const timeSlot = studentSchedule.headers[index + 1];
                    attendanceRecords[day][timeSlot] = { status: 'present' };
                }
            });
            renderStudentSchedule();
            saveData();
        }

        function initiateSwap(subject, day, timeSlot) {
            swapState = { active: true, source: { subject, day, timeSlot } };
            document.body.classList.add('swapping');
            closeModal();
            alert('Swap initiated. Now click on the class you want to swap with.');
        }
        
        function completeSwap(toDay, toTimeSlot) {
            const from = swapState.source;
            const fromDayIndex = studentSchedule.rows.findIndex(r => r[0] === from.day);
            const fromTimeIndex = studentSchedule.headers.indexOf(from.timeSlot);
            const toDayIndex = studentSchedule.rows.findIndex(r => r[0] === toDay);
            const toTimeIndex = studentSchedule.headers.indexOf(toTimeSlot);

            if (fromDayIndex === -1 || fromTimeIndex === -1 || toDayIndex === -1 || toTimeIndex === -1) {
                console.error("Swap failed: Invalid indices"); return;
            }

            const fromSubject = studentSchedule.rows[fromDayIndex][fromTimeIndex];
            const toSubject = studentSchedule.rows[toDayIndex][toTimeIndex];
            studentSchedule.rows[fromDayIndex][fromTimeIndex] = toSubject;
            studentSchedule.rows[toDayIndex][toTimeIndex] = fromSubject;
            
            if (!attendanceRecords[from.day]) attendanceRecords[from.day] = {};
            if (!attendanceRecords[toDay]) attendanceRecords[toDay] = {};
            const fromAttendance = attendanceRecords[from.day][from.timeSlot];
            const toAttendance = attendanceRecords[toDay][toTimeSlot];
            attendanceRecords[from.day][from.timeSlot] = toAttendance;
            attendanceRecords[toDay][toTimeSlot] = fromAttendance;

            swapState = { active: false, source: null };
            document.body.classList.remove('swapping');
            alert(`Swapped "${fromSubject}" with "${toSubject}".`);
            renderStudentSchedule();
            saveData();
        }

        function closeModal() {
            classActionModal.hide();
        }

        async function loadDataForWeek() {
            const loadingState = document.getElementById('loading-state');
            const appContent = document.getElementById('app-content');
            
            loadingState.classList.remove('d-none');
            appContent.classList.add('d-none');
            
            const monday = getMonday(currentDate);
            currentWeekId = formatDate(monday);
            document.getElementById('week-title').textContent = getWeekDisplayString(currentDate);

            try {
                const response = await fetch(`${API_URL}?weekId=${currentWeekId}`);
                if (!response.ok) throw new Error(`Failed to fetch data: ${response.statusText}`);
                
                const data = await response.json();
                studentSchedule = data.schedule;
                attendanceRecords = data.attendance || {};
                
                renderStudentSchedule();
            } catch (error) {
                console.error("Could not load data from backend:", error);
                document.getElementById('loading-state').innerHTML = `<p class="text-danger">Error connecting to the server. Please check the API_URL and make sure your backend is running.</p>`;
            } finally {
                loadingState.classList.add('d-none');
                appContent.classList.remove('d-none');
            }
        }
        
        async function saveData() {
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        weekId: currentWeekId,
                        schedule: studentSchedule, 
                        attendance: attendanceRecords 
                    }),
                });
            } catch (error) {
                console.error("Failed to save data:", error);
                alert("Could not save changes to the server.");
            }
        }

        function init() {
            classActionModal = new bootstrap.Modal(document.getElementById('class-action-modal'));
            document.getElementById('prev-week').onclick = () => {
                currentDate.setDate(currentDate.getDate() - 7);
                loadDataForWeek();
            };
            document.getElementById('next-week').onclick = () => {
                currentDate.setDate(currentDate.getDate() + 7);
                loadDataForWeek();
            };
            document.getElementById('today-btn').onclick = () => {
                currentDate = new Date();
                loadDataForWeek();
            };
            
            loadDataForWeek();
        }

        init();
    </script>
</body>
</html>

